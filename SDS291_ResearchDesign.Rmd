---
title: "Research Design"
author: "Katelyn Diaz, Sarah Fleming, Shevaughn Holness"
date: "4/1/2022"
output: pdf_document
bibliography: citations.bib

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
library(rio)
library(tidyverse)
library(ggplot2)
library(car)
library(broom)
library(stargazer)
```

```{r}
health_data <- read.csv("cleaned_health_data_complete.csv")
health_data$racial_majority <- as.factor(health_data$racial_majority)
health_data$hhd_income <- log(health_data$hhd_income)
```

## Background  


Despite the United States spending 19% of its GDP on healthcare in 2020 – the most of any other advanced country  —  health insurance rates have been declining unevenly since 2017 [@noauthor_nhe_nodate]. Health insurance not only serves an important role in reducing medical debt but it has also been linked to a significant decrease in mortality [@card_does_2007]. Despite the overall benefits to health, nearly 8.6% of the US population did not have health insurance in 2020 [@bureau_health_nodate].

While health insurance has undergone a multitude of good reforms over the past decade, not all demographics have felt the reforms evenly. Infact, recent reforms have been detrimental for some. With over half of the population getting employer-provided health insurance, people who face obstacles to employment, such as racial minorities, the disabled, and undocumented immigrants, are historically shown to have higher rates of being uninsured [@jul_16_health_2021]. With the passing of the Affordable Care Act in 2010, there was significant expansions in terms of healthcare coverage, with racial minorities seeing a significant increase in the insured population. However, later policy changes made by the Trump administration reversed these trends, with most minorities having an increase in the uninsured rates [@jul_16_health_2021]. 

Citizenship status also seems to be a crucial factor in determining uninsured rates. Michael S. Cohen’s and William L. Schpero (2018) found that mixed-citizenship status households were less likely to have health insurance due to the fear that it would warrant further inspection into the legality of household members [@cohen_household_2018].

In light of these shifts occurring in uninsured rates, we aim to investigate possible demographic determinants of county level uninsured rates. The two county level demographic determinants of interest for uninsured rates are county median household income and percentage of non US citizen residents. Median income is a significant factor regardless of employment status because higher-income households can afford private insurance. Undocumented people often barriers to employment, meaning that they may be less likely get a job with benefits, and thus, get health insurance from their employers. 

We suspect that as the percentage of non-citizens residents increase, the percent of the county’s population who are uninsured will also increase. We also suspect that as median income increases the percent of the county’s population who are uninsured will decrease.


## Methods

### Data

The dataset we will be using comes from the 2019 American Community Survey (ACS) collected by the United States Census Bureau; we chose 2019 as the year of interest as it is the most up-to-date and validated ACS [@bureau_2020_nodate], [@noauthor_explore_nodate]. The ACS collects demographic, housing, and economic information on the county level for the United States, Puerto Rico, and Guam. The U.S Census Bureau collected this information through the use of mailed questionnaires, telephone interviews, and visits from Census Bureau field representatives. This data is collected from 3.5 million household addresses annually and only in counties with at least 65,000 people[@noauthor_american_nodate]. 

The unit of analysis for this dataset is county, and there are eight hundred fifty-one total observations. From this dataset, we chose to focus on counties that are in the United States which leads to our dataset having eight hundred twenty-one observations. As we can only include a portion of the counties in the U.S., our dataset is a sample as the population of interest is all counties in the U.S. 
   
### Variables 

The analysis conducted includes the following variables: median household income, disability status, marriage status, employment status, US citizenship status, uninsured, and majority racial group.The response variable was the percentage of people who are uninsured, which is a continuous variable. The key variables analyzed were the continuous variables median income per county in dollars, and percentage of people who are citizens of the US. 

The covariates included the continuous variables percentage of people with a disability, percentage of people married, and percentage of people employed, along with the reference binary variable of if the county is majority white. For our analysis, race was mutated into a categorical variable consisting that stated which racial group held the majority in that county.  The reference group is `majority_white` (which indicates if the county is majority white). The other groups in the model are `majority_black`, `majority_hispanic`, and `majority_other`.

### Analysis 

**Null Hypothesis1:** The percentage of Non-US citizens in a county has no effect on the amount of people who are uninsured for a county.
**Alternative Hypothesis1 :**  The percentage of Non-US citizens in a county has an effect on the amount of people who are uninsured for a county.

**Null Hypothesis2:** The median household income in a county has no effect on the amount of people who are uninsured for a county.

**Alternative Hypothesis2**: The median household income in a county has an effect on the amount of people who are uninsured for a county.

Our primary hypothesis is that the percentage of Non US-Citizens inside a county as well as the median household income of a county have an effect on the percentage of uninsured people in that county. As such, we want to start with simple linear regression to show the relationship between each of those variables independently before moving to multiple regression to view their relationship with uninsured rates when controlling for other variables. Two of our models will be simple linear regression models that have either percentage of non US-citizens inside the county or median household income of the county as an explanatory variable for percentage of people who are uninsured. This would show if there was a relationship between the explanatory and the response variable when not controlling for other factors. 

We would then create numerous multiple regression models. The third model we create will have only the percentage of Non US-Citizens inside a county and the median household income as explanatory variables. We will include a full model that has all the covariates as well as the independent variables as a focus. The last few models will be the model produced after accounting for any potential multicollinearity. 

All models will be shown; the model that we will choose to discuss is the model that is indicated to be best fitted model by its R-Squared Adjusted, AIC, and BIC. We will check regression diagnostics for each model before running them. 
### Results

```{r}
## Scatterplots

scatter_income <- ggplot(health_data, aes(x = hhd_income, y = uninsured_pct)) +
  geom_point() +
  labs(x = "Household Income (log)", y = "Uninsured Percentage", title = "Relationship between Household Income of a county and Uninsured Rates") +
  theme_classic()
scatter_income

scatter_citizen <- ggplot(health_data, aes(x = notcitizen_pct, y = uninsured_pct)) +
  geom_point() +
  labs(x = "Household Income", y = "Uninsured Percentage", title = "Relationship between Non US Citizen Percentage of a county and Uninsured Rates") +
  theme_classic()
scatter_citizen
```

```{r}
## model creation

# Simple linear regression models
cit_model <- lm(uninsured_pct~notcitizen_pct, data = health_data)
hhd_model <- lm(uninsured_pct~ hhd_income, data = health_data)

# Both variables of interest models
cit_hhd_model <- lm(uninsured_pct~notcitizen_pct + hhd_income, data = health_data)

# full model
full_model <- lm(uninsured_pct~notcitizen_pct + hhd_income + employed_pct + disabled_pct + married_pct + racial_majority, data = health_data)

# Each variable of interest and controls
citi_fullmodel <- lm(uninsured_pct~notcitizen_pct + employed_pct + disabled_pct + married_pct + racial_majority, data = health_data)
hhd_full_model <- lm(uninsured_pct~  hhd_income + employed_pct + disabled_pct + married_pct + racial_majority, data = health_data)

# Adding AIC and BIC
hhd_model$AIC <- AIC(hhd_model)
cit_model$AIC <- AIC(cit_model)
full_model$AIC <- AIC(full_model)
cit_hhd_model$AIC <- AIC(cit_hhd_model)
hhd_full_model$AIC <- AIC(hhd_full_model)
citi_fullmodel$AIC <- AIC(citi_fullmodel)

hhd_model$BIC <- BIC(hhd_model)
cit_model$BIC <- BIC(cit_model)
full_model$BIC <- BIC(full_model)
cit_hhd_model$BIC <- BIC(cit_hhd_model)
hhd_full_model$BIC <- BIC(hhd_full_model)
citi_fullmodel$BIC <- BIC(citi_fullmodel)
```

```{r, warning=F, results='asis', echo=F}
stargazer( cit_model, hhd_model, cit_hhd_model, hhd_full_model, citi_fullmodel, full_model, type="latex", header=FALSE,
          title="Predicting County Uninsured Rates",
          covariate.labels=c("Citizenship Percentage", "Household income (log)" ,"Employment Percentage", "Disabled Percentage", "Marriage Percentage", "Racial Majority: Non-White"),
          keep.stat=c("aic", "bic", "adj.rsq"))
```

```{r}
### Predictions

# Creating data frames for predicion
noncitizen_data <- with(health_data, data.frame(population=mean(population), hhd_income = mean(hhd_income), disabled_pct = mean(disabled_pct), married_pct = mean(married_pct), employed_pct = mean(employed_pct), racial_majority = 'white', notcitizen_pct=0:15))

# generating the 95% CI becuase we don't have total certainty in our estimates
pred <- as.data.frame(predict(full_model, noncitizen_data, se.fit=TRUE))
noncitizen_data$pred_prob <- pred$fit
noncitizen_data$pred_lower <- pred$fit-(1.96*pred$se.fit)
noncitizen_data$pred_upper <- pred$fit+(1.96*pred$se.fit)

# We can make the line that shows the predicted prob- holding all other variables at mean value
noncit_plot <- ggplot(noncitizen_data, aes(x=notcitizen_pct, y=pred_prob))+
  geom_ribbon(aes(ymin = pred_lower, ymax = pred_upper),fill = "grey70")+
  geom_line() +
  labs(x = "Percentage of Non U.S. Citizens in the County", y = "Predicted Probability", title = "Relationship between U.S. Citizenship Percentage of a county and Uninsured Rates") +
  theme_classic()
```

```{r}
# creating new dataframe where everything but perimeter is held constant
hhd_data <- with(health_data, data.frame(population=mean(population), disabled_pct = mean(disabled_pct), married_pct = mean(married_pct), employed_pct = mean(employed_pct), racial_majority = 'white', notcitizen_pct=mean(notcitizen_pct), hhd_income = seq(from = 11, to = 14, length.out = 20)))

# predict the values
pred <- as.data.frame(predict(full_model, hhd_data, type="response", se.fit=TRUE))

# creating the columns that indicate the prediction and its upper and lower bounds
hhd_data$pred_prob <- pred$fit
hhd_data$pred_lower <- pred$fit-(1.96*pred$se.fit)
hhd_data$pred_upper <- pred$fit+(1.96*pred$se.fit)

# We can make the line that shows the predicted prob- holding all other variables at mean value
hhd_plot <- ggplot(hhd_data, aes(x=hhd_income, y=pred_prob))+
  geom_ribbon(aes(ymin = pred_lower, ymax = pred_upper),fill = "grey70")+
  geom_line() +
  labs(x = "Household Income of the County", y = "Predicted Probability", title = "Relationship between household of a county and Uninsured Rates") +
  theme_classic()
```

```{r}
noncit_plot
```


```{r}
hhd_plot
```


### Appendix

Histograms of variables of interest

```{r}
histogram_income <- ggplot(health_data, aes(x = hhd_income)) +
  geom_histogram() +
  theme_classic()

histogram_scatter <- ggplot(health_data, aes(x = notcitizen_pct)) +
  geom_histogram() +
  theme_classic()
```

Variance Inflatin Factor tests

```{r, eval=FALSE}
v1 <- vif(cit_hhd_model)
v2 <- vif(full_model)
v3 <- vif(hhd_full_model)
v4 <- vif(citi_fullmodel)
```

Testing models for assumptions 

```{r, eval = F}
## Employment_model
resid_data <- augment(hhd_model)

## Histogram of Residuals
hist_plt <- ggplot(resid_data, aes(x=.resid)) +
geom_histogram(binwidth=1) +xlab("Residual")
 
#Scatter plot between predicted values and residuals
resid_plt <- ggplot(resid_data, aes(x=.fitted, y=.resid)) +
  geom_point()

# qqplot
qq_plt <- plot(hhd_model, which=2,  id.n = NULL)
```

```{r, eval = F}
## non citizen model
resid_data <- augment(cit_model)

## Histogram of Residuals
hist_plt <- ggplot(resid_data, aes(x=.resid)) +
geom_histogram(binwidth=1) +xlab("Residual")
 
# Scatter plot between predicted values and residuals
resid_plt <- ggplot(resid_data, aes(x=.fitted, y=.resid)) +
  geom_point()

# qqplot
qq_plt <- plot(cit_model, which=2,  id.n = NULL)
```
```{r, eval = F}
resid_data <- augment(cit_hhd_model)

## Histogram of Residuals
 
hist_plt <- ggplot(resid_data, aes(x=.resid)) +
geom_histogram(binwidth=1) +xlab("Residual")
 
# Scatter plot between predicted values and residuals
resid_plt <- ggplot(resid_data, aes(x=.fitted, y=.resid)) +
  geom_point()

# qqplot
qq_plt <- plot(cit_hhd_model, which=2,  id.n = NULL)
```

```{r, eval = F}
resid_data <- augment(full_model)

## Histogram of Residuals
 
hist_plt <- ggplot(resid_data, aes(x=.resid)) +
geom_histogram(binwidth=1) +xlab("Residual")
 
# Scatter plot between predicted values and residuals
resid_plt <- ggplot(resid_data, aes(x=.fitted, y=.resid)) +
  geom_point()

# qqplot
qq_plt <- plot(full_model, which=2,  id.n = NULL)
```

```{r, eval = F}
resid_data <- augment(hhd_full_model)

## Histogram of Residuals
 
hist_plt <- ggplot(resid_data, aes(x=.resid)) +
geom_histogram(binwidth=1) +xlab("Residual")
 
# Scatter plot between predicted values and residuals
resid_plt <-  ggplot(resid_data, aes(x=.fitted, y=.resid)) +
  geom_point()

# qqplot
qq_plt <- plot(hhd_full_model, which=2,  id.n = NULL)
```

```{r, eval = F}
resid_data <- augment(citi_fullmodel)

## Histogram of Residuals
 
hist_plt <- ggplot(resid_data, aes(x=.resid)) +
geom_histogram(binwidth=1) +xlab("Residual")
 
# Scatter plot between predicted values and residuals
resid_plt <- ggplot(resid_data, aes(x=.fitted, y=.resid)) +
  geom_point()

qq_plt <- plot(citi_fullmodel, which=2,  id.n = NULL)
```


## Bibliography 
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{8pt}
\noindent

